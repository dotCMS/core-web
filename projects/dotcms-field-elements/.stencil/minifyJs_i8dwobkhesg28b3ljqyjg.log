import*as tslib_1 from"../polyfills/tslib.js";import{h}from"../dotcmsfields.core.js";import{a as Fragment}from"./chunk-1d89c98b.js";import{a as getOriginalStatus,f as updateStatus,c as getClassNames}from"./chunk-62cd3eff.js";import{d as getErrorMessage,e as getFieldsFromLayout,f as fieldCustomProcess}from"./chunk-4205a04e.js";var DotUploadService=function(){function t(){}return t.prototype.uploadFile=function(t,e){return"string"==typeof t?this.uploadFileByURL(t):this.uploadBinaryFile(t,e)},t.prototype.uploadFileByURL=function(t){var e=this;return fetch("/api/v1/temp/byUrl",{method:"POST",headers:{"Content-Type":"application/json",Origin:window.location.hostname},body:JSON.stringify({remoteUrl:t})}).then(function(t){return tslib_1.__awaiter(e,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(o){switch(o.label){case 0:return 200!==t.status?[3,2]:[4,t.json()];case 1:return[2,o.sent().tempFiles[0]];case 2:return e={},[4,t.json()];case 3:throw e.message=o.sent().message,e.status=t.status,e}})})})},t.prototype.uploadBinaryFile=function(t,e){var o=this,r="/api/v1/temp";r+=e?"?maxFileLength="+e:"";var a=new FormData;return a.append("file",t),fetch(r,{method:"POST",headers:{Origin:window.location.hostname},body:a}).then(function(t){return tslib_1.__awaiter(o,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(o){switch(o.label){case 0:return 200!==t.status?[3,2]:[4,t.json()];case 1:return[2,o.sent().tempFiles[0]];case 2:return e={},[4,t.json()];case 3:throw e.message=o.sent().message,e.status=t.status,e}})})})},t}(),SUBMIT_FORM_API_URL="/api/v1/workflow/actions/default/fire/NEW",fallbackErrorMessages={500:"500 Internal Server Error",400:"400 Bad Request",401:"401 Unauthorized Error"},DotFormComponent=function(){function DotFormComponent(){this.resetLabel="Reset",this.submitLabel="Submit",this.layout=[],this.variable="",this.status=getOriginalStatus(),this.errorMessage="",this.uploadFileInProgress=!1,this.fieldsStatus={},this.value={}}return DotFormComponent.prototype.onValueChange=function(t){var e=this,o=t.target.tagName,r=t.detail,a=r.name,n=r.value,s=fieldCustomProcess[o];"DOT-BINARY-FILE"===o&&n?this.uploadFile(t).then(function(t){e.value[a]=t&&t.id}):this.value[a]=s?s(n):n},DotFormComponent.prototype.onStatusChange=function(t){var e=t.detail;this.fieldsStatus[e.name]=e.status,this.status=updateStatus(this.status,{dotTouched:this.getTouched(),dotPristine:this.getStatusValueByName("dotPristine"),dotValid:this.getStatusValueByName("dotValid")})},DotFormComponent.prototype.layoutWatch=function(){this.value=this.getUpdateValue()},DotFormComponent.prototype.fieldsToShowWatch=function(){this.value=this.getUpdateValue()},DotFormComponent.prototype.hostData=function(){return{class:getClassNames(this.status,this.status.dotValid)}},DotFormComponent.prototype.componentWillLoad=function(){this.value=this.getUpdateValue()},DotFormComponent.prototype.render=function(){var t=this;return h(Fragment,null,h("form",{onSubmit:this.handleSubmit.bind(this)},this.layout.map(function(e){return h("dot-form-row",{row:e,"fields-to-show":t.fieldsToShow})}),h("div",{class:"dot-form__buttons"},h("button",{type:"reset",onClick:function(){return t.resetForm()}},this.resetLabel),h("button",{type:"submit",disabled:!this.status.dotValid||this.uploadFileInProgress},this.submitLabel))),h("dot-error-message",null,this.errorMessage))},DotFormComponent.prototype.getStatusValueByName=function(t){return Object.values(this.fieldsStatus).map(function(e){return e[t]}).every(function(t){return!0===t})},DotFormComponent.prototype.getTouched=function(){return Object.values(this.fieldsStatus).map(function(t){return t.dotTouched}).includes(!0)},DotFormComponent.prototype.handleSubmit=function(t){var e=this;t.preventDefault(),fetch(SUBMIT_FORM_API_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({contentlet:Object.assign({contentType:this.variable},this.value)})}).then(function(t){return tslib_1.__awaiter(e,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(o){switch(o.label){case 0:return 200===t.status?[3,2]:(e={},[4,t.text()]);case 1:throw e.message=o.sent(),e.status=t.status,e;case 2:return[2,t.json()]}})})}).then(function(t){e.runSuccessCallback(t.entity)}).catch(function(t){var o=t.status;e.errorMessage=getErrorMessage(t.message)||fallbackErrorMessages[o]})},DotFormComponent.prototype.runSuccessCallback=function(contentlet){var successCallback=this.getSuccessCallback();if(successCallback)return function(){return eval(successCallback)}.call({contentlet:contentlet})},DotFormComponent.prototype.getSuccessCallback=function(){return getFieldsFromLayout(this.layout).filter(function(t){return"formSuccessCallback"===t.variable})[0].values},DotFormComponent.prototype.resetForm=function(){Array.from(this.el.querySelectorAll("form dot-form-column > *")).forEach(function(t){try{t.reset()}catch(e){console.warn(""+t.tagName,e)}})},DotFormComponent.prototype.getUpdateValue=function(){return getFieldsFromLayout(this.layout).filter(function(t){return!1===t.fixed}).reduce(function(t,e){var o;return Object.assign({},t,((o={})[e.variable]=e.defaultValue||("TEXT"!==e.dataType?e.values:null),o))},{})},DotFormComponent.prototype.getMaxSize=function(t){var e=t.target.attributes.slice().filter(function(t){return"max-file-length"===t.name})[0];return e&&e.value},DotFormComponent.prototype.uploadFile=function(t){var e=this,o=new DotUploadService,r=t.detail.value,a=this.getMaxSize(t),n=t.target;return!a||r.size<=a?(this.uploadFileInProgress=!0,n.errorMessage="",o.uploadFile(r,a).then(function(t){return e.errorMessage="",n.previewImageUrl=t.thumbnailUrl,n.previewImageName=t.fileName,e.uploadFileInProgress=!1,t}).catch(function(t){var o=t.message,r=t.status;return n.clearValue(),e.uploadFileInProgress=!1,e.errorMessage=getErrorMessage(o)||fallbackErrorMessages[r],null})):(n.reset(),n.errorMessage="File size larger than allowed "+a+" bytes",Promise.resolve(null))},Object.defineProperty(DotFormComponent,"is",{get:function(){return"dot-form"},enumerable:!0,configurable:!0}),Object.defineProperty(DotFormComponent,"properties",{get:function(){return{el:{elementRef:!0},errorMessage:{state:!0},fieldsToShow:{type:String,attr:"fields-to-show",watchCallbacks:["fieldsToShowWatch"]},layout:{type:"Any",attr:"layout",reflectToAttr:!0,watchCallbacks:["layoutWatch"]},resetLabel:{type:String,attr:"reset-label",reflectToAttr:!0},status:{state:!0},submitLabel:{type:String,attr:"submit-label",reflectToAttr:!0},uploadFileInProgress:{state:!0},variable:{type:String,attr:"variable",reflectToAttr:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(DotFormComponent,"listeners",{get:function(){return[{name:"valueChange",method:"onValueChange"},{name:"statusChange",method:"onStatusChange"}]},enumerable:!0,configurable:!0}),Object.defineProperty(DotFormComponent,"style",{get:function(){return"/**style-placeholder:dot-form:**/"},enumerable:!0,configurable:!0}),DotFormComponent}();export{DotFormComponent as DotForm};